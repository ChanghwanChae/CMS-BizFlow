<?xml version="1.0" encoding="UTF-8"?>
<hy:rulebase cache="false" context="/" disable="true" forward_chain="false" return="/" xmlns="http://www.hyfinity.com/xstore" xmlns:bzf="http://www.handysoft.com/bizflow" xmlns:demo="http://www.hyfinity.com/schemas" xmlns:fm="http://www.hyfinity.com/formmaker" xmlns:hy="http://www.hyfinity.com/xengine" xmlns:m0="http://www.handysoft.com/webservice/ServiceConstructor" xmlns:mvc="http://www.hyfinity.com/mvc" xmlns:ns10="http://element.je.wf.bf.hs.com" xmlns:ns11="http://xml.apache.org/axis/" xmlns:ns2="http://www.hyfinity.com/xstore" xmlns:ns3="http://handysoft.com/webservice/HWProcess" xmlns:ns4="http://handysoft.com/webservice/ServiceConstructor" xmlns:ns5="http://service.je.wf.bf.hs.com" xmlns:ns6="http://handysoft.com/webservice/HWSession" xmlns:ns7="http://handysoft.com/webservice/HWProcessDefinition" xmlns:ns8="http://www.hyfinity.com/xplatform" xmlns:ns9="http://www.hyfinity.com/xfactory" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/" xmlns:soapenc="http://schemas.xmlsoap.org/soap/encoding/" xmlns:xform="http://www.w3.org/2001/08/xforms" xmlns:xg="http://www.hyfinity.com/xgate" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
	<hy:workspace name="save_request" />
	<hy:rule base="modified" desc="merge the incoming data with the cached WIC data to produce the PV data that needs to be saved in BizFlow." disable="false" id="save_BizFlowService-Access_Service_from_WorkitemContext-Controller_rule" priority="10">
		<hy:head>
			<hy:result disable="false" id="create_cached_wic">
				<hy:operator>Parse</hy:operator>
				<hy:target action="add" name="factbase" update="append">
					<hy:params>
						<hy:param name="fragment" type="org.w3c.dom.Node">
							<cached_wic xmlns="" />
						</hy:param>
						<hy:param name="to_location" type="com.hyfinity.xpath.XPath">/mvc:eForm/mvc:Data</hy:param>
					</hy:params>
				</hy:target>
			</hy:result>
			<hy:result disable="false" id="retrieve_cached_wic">
				<hy:operator>Retrieve</hy:operator>
				<hy:target action="retireve" name="retireve" update="">
					<hy:params>
						<hy:param name="cache_id" type="java.lang.String">workitem_context</hy:param>
						<hy:param name="scope" type="java.lang.String">session</hy:param>
						<hy:param name="location" type="com.hyfinity.xpath.XPath">/mvc:eForm/mvc:Data/cached_wic</hy:param>
					</hy:params>
				</hy:target>
			</hy:result>
			<hy:result disable="false" id="create_save_request">
				<hy:operator>Parse</hy:operator>
				<hy:target action="add" name="factbase" update="append">
					<hy:params>
						<hy:param name="fragment" type="org.w3c.dom.Node">
							<SaveWorkitemContext xmlns="" />
						</hy:param>
						<hy:param name="to_location" type="com.hyfinity.xpath.XPath">/mvc:eForm/mvc:Data</hy:param>
					</hy:params>
				</hy:target>
			</hy:result>
			<hy:result disable="false" id="merge_wic_info">
				<hy:operator>Transform</hy:operator>
				<hy:target action="transform" name="XSLT" update="append">
					<hy:params>
						<hy:param name="stylesheet" type="java.io.File">RepurposePVsForBizFlow.xsl</hy:param>
						<hy:param name="from_location" type="com.hyfinity.xpath.XPath">/</hy:param>
						<hy:param name="to_location" type="com.hyfinity.xpath.XPath">/mvc:eForm/mvc:Data/SaveWorkitemContext</hy:param>
					</hy:params>
				</hy:target>
			</hy:result>
		</hy:head>
		<hy:body />
	</hy:rule>
	<hy:rule base="custom" desc="" disable="false" id="check_session_expired" priority="50">
		<hy:head>
			<hy:result disable="false" id="set error details for display to user">
				<hy:operator>Parse</hy:operator>
				<hy:target action="add" name="factbase" update="append">
					<hy:params>
						<hy:param name="fragment" type="org.w3c.dom.Node">
							<error category="Fatal" desc="Unfortunately your session has expired. Please log in to BizFlow again and restart this workitem. - Ref:1001" xmlns="">1001</error>
						</hy:param>
						<hy:param name="to_location" type="com.hyfinity.xpath.XPath">/mvc:eForm/mvc:Control</hy:param>
					</hy:params>
				</hy:target>
			</hy:result>
			<hy:result disable="false" id="set requested WIH to error">
				<hy:operator>Write</hy:operator>
				<hy:target action="write" name="factbase" update="">
					<hy:params>
						<hy:param name="value" type="java.lang.String">error</hy:param>
						<hy:param name="to_location" type="com.hyfinity.xpath.XPath">/mvc:eForm/mvc:Data/mvc:formData/mvc:*[starts-with(local-name(), 'WIH_') and contains(local-name(), '_requested') and . = 'true']</hy:param>
					</hy:params>
				</hy:target>
			</hy:result>
			<hy:result disable="false" id="reset controller to stop further processing">
				<hy:operator>Write</hy:operator>
				<hy:target action="write" name="factbase" update="">
					<hy:params>
						<hy:param name="value" type="java.lang.String" />
						<hy:param name="to_location" type="com.hyfinity.xpath.XPath">/mvc:eForm/mvc:Control/mvc:Controller</hy:param>
					</hy:params>
				</hy:target>
			</hy:result>
			<hy:result disable="false" id="set read only to stop user changes">
				<hy:operator>Write</hy:operator>
				<hy:target action="write" name="factbase" update="">
					<hy:params>
						<hy:param name="value" type="java.lang.String">R</hy:param>
						<hy:param name="to_location" type="com.hyfinity.xpath.XPath">/mvc:eForm/mvc:Data/WorkitemContext/Application/Updatable</hy:param>
					</hy:params>
				</hy:target>
			</hy:result>
			<hy:result disable="false" id="stop procesing">
				<hy:operator>Return</hy:operator>
				<hy:target action="return" name="factbase" update="">
					<hy:params />
				</hy:target>
			</hy:result>
		</hy:head>
		<hy:body>
			<hy:clause id="check cached session contents lost" multiple="false">
				<hy:operator>Read</hy:operator>
				<hy:target action="eval" name="factbase">
					<hy:params>
						<hy:param name="xpath_expression" type="com.hyfinity.xpath.XPath">not(/mvc:eForm/mvc:Data/cached_wic/WorkitemContext/*)</hy:param>
					</hy:params>
				</hy:target>
			</hy:clause>
		</hy:body>
	</hy:rule>
	<hy:rule base="custom" desc="" disable="false" id="save_updated_date_to_bizflow" priority="60">
		<hy:head>
			<hy:result disable="false" id="call_service">
				<hy:operator>Service</hy:operator>
				<hy:target action="Invoke" name="mvc-cms_erlr_general-SaveWICDetails-UpdateBizFlow" parallel="false" update="append">
					<hy:params>
						<hy:param name="from_location" type="com.hyfinity.xpath.XPath">/mvc:eForm/mvc:Data/SaveWorkitemContext/WorkitemContext</hy:param>
						<hy:param name="to_location" type="com.hyfinity.xpath.XPath">$save_request</hy:param>
					</hy:params>
				</hy:target>
			</hy:result>
		</hy:head>
		<hy:body>
			<hy:clause id="check_for_update_pv_req" multiple="false">
				<hy:operator>Read</hy:operator>
				<hy:target action="eval" name="factbase">
					<hy:params>
						<hy:param name="xpath_expression" type="com.hyfinity.xpath.XPath">/mvc:eForm/mvc:Data/SaveWorkitemContext/WorkitemContext</hy:param>
					</hy:params>
				</hy:target>
			</hy:clause>
		</hy:body>
	</hy:rule>
	<hy:rule base="custom" desc="" disable="false" id="cleanup_for_controller" priority="70">
		<hy:head>
			<hy:result disable="false" id="move_merged_WIC">
				<hy:operator>Move</hy:operator>
				<hy:target action="add" name="factbase" update="replace">
					<hy:params>
						<hy:param name="from_location" type="com.hyfinity.xpath.XPath">/mvc:eForm/mvc:Data/SaveWorkitemContext/WorkitemContext</hy:param>
						<hy:param name="to_location" type="com.hyfinity.xpath.XPath">/mvc:eForm/mvc:Data/WorkitemContext</hy:param>
					</hy:params>
				</hy:target>
			</hy:result>
			<hy:result disable="false" id="delete_old_cache">
				<hy:operator>Delete</hy:operator>
				<hy:target action="remove" name="factbase" update="">
					<hy:params>
						<hy:param name="from_location" type="com.hyfinity.xpath.XPath">/mvc:eForm/mvc:Data/cached_wic</hy:param>
					</hy:params>
				</hy:target>
			</hy:result>
			<hy:result disable="false" id="delete_empty_container">
				<hy:operator>Delete</hy:operator>
				<hy:target action="remove" name="factbase" update="">
					<hy:params>
						<hy:param name="from_location" type="com.hyfinity.xpath.XPath">/mvc:eForm/mvc:Data/SaveWorkitemContext</hy:param>
					</hy:params>
				</hy:target>
			</hy:result>
			<hy:result disable="false" id="TransformProcessVariables">
				<hy:operator>Transform</hy:operator>
				<hy:target action="transform" name="XSLT" update="replace">
					<hy:params>
						<hy:param name="stylesheet" type="java.io.File">RepurposePVsForWebMaker.xsl</hy:param>
						<hy:param name="from_location" type="com.hyfinity.xpath.XPath">/mvc:eForm/mvc:Data/WorkitemContext/Process/ProcessVariables</hy:param>
						<hy:param name="to_location" type="com.hyfinity.xpath.XPath">/mvc:eForm/mvc:Data/WorkitemContext/Process/ProcessVariables</hy:param>
					</hy:params>
				</hy:target>
			</hy:result>
		</hy:head>
		<hy:body />
	</hy:rule>
	<hy:rule base="custom" desc="" disable="false" id="retrieve_bizflowDetails_from_Cache" priority="40">
		<hy:head>
			<hy:result disable="false" id="Retrieve bizflow details from cache">
				<hy:operator>Retrieve</hy:operator>
				<hy:target action="retireve" name="retireve" update="append">
					<hy:params>
						<hy:param name="cache_id" type="java.lang.String">bizflow_details</hy:param>
						<hy:param name="scope" type="java.lang.String">session</hy:param>
						<hy:param name="location" type="com.hyfinity.xpath.XPath">/mvc:eForm/mvc:Data/cached_bizflow_details</hy:param>
					</hy:params>
				</hy:target>
			</hy:result>
			<hy:result disable="false" id="Copy read only to the control block">
				<hy:operator>Copy</hy:operator>
				<hy:target action="add" name="factbase" update="append">
					<hy:params>
						<hy:param name="from_location" type="com.hyfinity.xpath.XPath">/mvc:eForm/mvc:Data/cached_bizflow_details/mvc:readOnly</hy:param>
						<hy:param name="to_location" type="com.hyfinity.xpath.XPath">/mvc:eForm/mvc:Control</hy:param>
					</hy:params>
				</hy:target>
			</hy:result>
			<hy:result disable="false" id="Remove bizflow details">
				<hy:operator>Delete</hy:operator>
				<hy:target action="remove" name="factbase" update="">
					<hy:params>
						<hy:param name="from_location" type="com.hyfinity.xpath.XPath">/mvc:eForm/mvc:Data/cached_bizflow_details</hy:param>
					</hy:params>
				</hy:target>
			</hy:result>
		</hy:head>
		<hy:body />
	</hy:rule>
	<hy:rule base="custom" desc="" disable="false" id="CacheModifiedWICDetails" priority="65">
		<hy:head>
			<hy:result disable="false" id="CacheModifiedWICDetails">
				<hy:operator>Cache</hy:operator>
				<hy:target action="cache" name="cache" update="">
					<hy:params>
						<hy:param name="location" type="com.hyfinity.xpath.XPath">/mvc:eForm/mvc:Data/SaveWorkitemContext/WorkitemContext</hy:param>
						<hy:param name="cache_id" type="java.lang.String">workitem_context</hy:param>
						<hy:param name="scope" type="java.lang.String">session</hy:param>
					</hy:params>
				</hy:target>
			</hy:result>
		</hy:head>
		<hy:body />
	</hy:rule>
	<hy:rule base="custom" desc="" disable="false" id="Delete Modified Attributes" priority="63">
		<hy:head>
			<hy:result disable="false" id="delete changed attribute">
				<hy:operator>Delete</hy:operator>
				<hy:target action="remove" name="factbase" update="">
					<hy:params>
						<hy:param name="from_location" type="com.hyfinity.xpath.XPath">.</hy:param>
					</hy:params>
				</hy:target>
			</hy:result>
		</hy:head>
		<hy:body>
			<hy:clause id="all modified PVs" multiple="true">
				<hy:operator>Read</hy:operator>
				<hy:target action="eval" name="factbase">
					<hy:params>
						<hy:param name="xpath_expression" type="com.hyfinity.xpath.XPath">/mvc:eForm/mvc:Data/SaveWorkitemContext/WorkitemContext/Process/ProcessVariables/ProcessVariable/Value/@unchanged_on_screen</hy:param>
					</hy:params>
				</hy:target>
			</hy:clause>
		</hy:body>
	</hy:rule>
</hy:rulebase>
