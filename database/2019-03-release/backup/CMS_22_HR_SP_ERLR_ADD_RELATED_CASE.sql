create or replace PROCEDURE SP_ERLR_ADD_RELATED_CASE
(
    I_CASE_NUMBER IN NUMBER,
    I_RELATED_CASE_NUMBER IN NUMBER,
    I_AUTO_TRIGGERED IN CHAR, -- T: AUTO TRIGGERED CASE, F: MANUALLY ENTERED CASE
	I_MEMBER_ID IN VARCHAR2 -- MANUALLY ENTERED CASE IF THIS VALUE IS NOT NULL
)
IS
    V_CNT NUMBER;
    V_MEMBER_NAME VARCHAR2(100);
    V_TRIGGER_F CHAR(1);
BEGIN
    -- VAIDATE I_CASE_NUMBER
    SELECT COUNT(*)
      INTO V_CNT
      FROM ERLR_CASE
     WHERE ERLR_CASE_NUMBER = I_CASE_NUMBER;

    IF 0 < V_CNT THEN
        
        IF I_AUTO_TRIGGERED = 'F' THEN
            SELECT M.NAME
              INTO V_MEMBER_NAME
              FROM BIZFLOW.MEMBER M
             WHERE M.MEMBERID = I_MEMBER_ID;
        END IF;
    
        SELECT COUNT(*)
          INTO V_CNT
          FROM ERLR_RELATED_CASE
         WHERE CASE_NUMBER = I_CASE_NUMBER
           AND RELATED_CASE_NUMBER = I_RELATED_CASE_NUMBER;
        
        IF 0 = V_CNT THEN
            INSERT INTO ERLR_RELATED_CASE(CASE_NUMBER, RELATED_CASE_NUMBER, TRIGGER_F, M_DT, M_MEMBER_ID, M_MEMBER_NAME)
                                  VALUES (I_CASE_NUMBER, I_RELATED_CASE_NUMBER, I_AUTO_TRIGGERED, CAST(SYS_EXTRACT_UTC(SYSTIMESTAMP) AS DATE), I_MEMBER_ID, V_MEMBER_NAME);            
        END IF;
    END IF;

EXCEPTION
	WHEN OTHERS THEN
		SP_ERROR_LOG();
END;