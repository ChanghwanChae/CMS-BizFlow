create or replace PROCEDURE SP_ERLR_EMPLOYEE_CASE_ADD
(
	I_HHSID IN VARCHAR2,
	I_CASEID IN NUMBER,
    I_CASE_TYPE_ID IN NUMBER,
	I_FROM_CASEID IN NUMBER,
	I_MEMBER_ID IN VARCHAR2 -- MANUALLY ENTERED CASE IF THIS VALUE IS NOT NULL
)
IS
    V_CNT NUMBER;
    V_CASE_TYPE_NAME VARCHAR2(100);
    V_FIRST_NAME VARCHAR2(50);
    V_LAST_NAME VARCHAR2(50);
    V_CASE_EMP_ID VARCHAR2(100);
BEGIN
    IF I_HHSID IS NULL THEN
        SELECT COUNT(*)
          INTO V_CNT
          FROM ERLR_EMPLOYEE_CASE
         WHERE HHSID IS NULL
           AND CASEID = I_CASEID;

        IF 0=V_CNT THEN
            SELECT TBL_LABEL
              INTO V_CASE_TYPE_NAME
              FROM TBL_LOOKUP
             WHERE TBL_ID = I_CASE_TYPE_ID;
             
            SELECT XMLQUERY('/formData/items/item[id="GEN_EMPLOYEE_ID"]/value/text()' PASSING FIELD_DATA RETURNING CONTENT).GETSTRINGVAL() 
              INTO V_CASE_EMP_ID
              FROM TBL_FORM_DTL F JOIN BIZFLOW.RLVNTDATA P ON F.PROCID = P.PROCID AND P.RLVNTDATANAME='caseNumber'
             WHERE P.VALUE = TO_CHAR(I_CASEID);
            
            IF 1<LENGTH(V_CASE_EMP_ID) THEN
                BEGIN
                    SELECT FIRST_NAME, LAST_NAME 
                      INTO V_FIRST_NAME, V_LAST_NAME 
                    FROM HHS_HR.EMPLOYEE_LOOKUP           
                    WHERE HHSID = V_CASE_EMP_ID;
                EXCEPTION WHEN NO_DATA_FOUND THEN
                    V_FIRST_NAME := NULL;
                    V_LAST_NAME := NULL;
                END;
            END IF;
            
            IF I_MEMBER_ID IS NULL THEN
                INSERT INTO ERLR_EMPLOYEE_CASE(HHSID, CASEID, FROM_CASEID, CASE_TYPE_ID, CASE_TYPE_NAME, EMP_LAST_NAME, EMP_FIRST_NAME)
                                        VALUES(I_HHSID, I_CASEID, I_FROM_CASEID, I_CASE_TYPE_ID, V_CASE_TYPE_NAME, V_LAST_NAME, V_FIRST_NAME);
            ELSE
                INSERT INTO ERLR_EMPLOYEE_CASE(HHSID, CASEID, FROM_CASEID, CASE_TYPE_ID, CASE_TYPE_NAME, EMP_LAST_NAME, EMP_FIRST_NAME, M_DT, M_MEMBER_ID, M_MEMBER_NAME)
                SELECT I_HHSID, I_CASEID, I_FROM_CASEID, I_CASE_TYPE_ID, V_CASE_TYPE_NAME, V_LAST_NAME, V_FIRST_NAME, CAST(SYS_EXTRACT_UTC(SYSTIMESTAMP) AS DATE), I_MEMBER_ID, M.NAME
                  FROM BIZFLOW.MEMBER M
                 WHERE M.MEMBERID = I_MEMBER_ID;
            END IF;
        END IF;
    ELSE
        SELECT COUNT(*)
          INTO V_CNT
          FROM ERLR_EMPLOYEE_CASE
         WHERE HHSID = I_HHSID
           AND CASEID = I_CASEID;

        IF 0=V_CNT THEN
            SELECT TBL_LABEL
              INTO V_CASE_TYPE_NAME
              FROM TBL_LOOKUP
             WHERE TBL_ID = I_CASE_TYPE_ID;
             
            SELECT XMLQUERY('/formData/items/item[id="GEN_EMPLOYEE_ID"]/value/text()' PASSING FIELD_DATA RETURNING CONTENT).GETSTRINGVAL() 
              INTO V_CASE_EMP_ID
              FROM TBL_FORM_DTL F JOIN BIZFLOW.RLVNTDATA P ON F.PROCID = P.PROCID AND P.RLVNTDATANAME='caseNumber'
             WHERE P.VALUE = TO_CHAR(I_CASEID);
            
            IF 1<LENGTH(V_CASE_EMP_ID) THEN
                BEGIN
                    SELECT FIRST_NAME, LAST_NAME 
                      INTO V_FIRST_NAME, V_LAST_NAME 
                    FROM HHS_HR.EMPLOYEE_LOOKUP           
                    WHERE HHSID = V_CASE_EMP_ID;
                EXCEPTION WHEN NO_DATA_FOUND THEN
                    V_FIRST_NAME := NULL;
                    V_LAST_NAME := NULL;
                END;
            END IF;
        
            IF I_MEMBER_ID IS NULL THEN
                INSERT INTO ERLR_EMPLOYEE_CASE(HHSID, CASEID, FROM_CASEID, CASE_TYPE_ID, CASE_TYPE_NAME, EMP_LAST_NAME, EMP_FIRST_NAME)
                                        VALUES(I_HHSID, I_CASEID, I_FROM_CASEID, I_CASE_TYPE_ID, V_CASE_TYPE_NAME, V_LAST_NAME, V_FIRST_NAME);
            ELSE
                INSERT INTO ERLR_EMPLOYEE_CASE(HHSID, CASEID, FROM_CASEID, CASE_TYPE_ID, CASE_TYPE_NAME, EMP_LAST_NAME, EMP_FIRST_NAME, M_DT, M_MEMBER_ID, M_MEMBER_NAME)
                SELECT I_HHSID, I_CASEID, I_FROM_CASEID, I_CASE_TYPE_ID, V_CASE_TYPE_NAME, V_LAST_NAME, V_FIRST_NAME, CAST(SYS_EXTRACT_UTC(SYSTIMESTAMP) AS DATE), I_MEMBER_ID, M.NAME
                  FROM BIZFLOW.MEMBER M
                 WHERE M.MEMBERID = I_MEMBER_ID;
            END IF;
        END IF;
    END IF;
    

EXCEPTION
	WHEN OTHERS THEN
		SP_ERROR_LOG();
END;